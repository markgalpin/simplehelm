resources:
  - name: simplehelmChart
    type: HelmChart
    configuration:
      sourceArtifactory: demoArt
      repository: helm
      chart: simplehelm
      version: 0.0.0

  - name: simplehelmRepo_chart
    type: GitRepo
    configuration:
      gitProvider: markg_github
      path: markgalpin/simplehelm
      files:
        include: "simplehelm.*"

  - name: simplehelmRepo_docker
    type: GitRepo
    configuration:
      gitProvider: markg_github
      path: markgalpin/simplehelm
      files:
        include: "Dockerfile|server.js|package.json"

  - name: simplehelmDockerImage1
    type: Image
    configuration:
      registry: demoArt
      sourceRepository: docker-local
      imageName: 35.224.208.129:8082/docker-local/simplehelm
      imageTag: latest

pipelines:
  - name: helm_full_flow
    steps:
      - name: dockerBuildPush
        type: Bash
        configuration:
          integrations:
            - name: demoArt
          inputResources:
            - name: simplehelmRepo_docker
          outputResources:
            - name: simplehelmDockerImage1
        execution:
          onExecute:
            - pushd $res_simplehelmRepo_docker_resourcePath
            - docker build -t 35.224.208.129:8082/docker-local/simplehelm:$run_number .
            - jfrog rt docker-push 35.224.208.129:8082/docker-local/simplehelm:$run_number docker-local --build-name=$pipeline_name --build-number=$run_number
            - write_output simplehelmDockerImage1 "imageTag=$run_number"

      - name: publish_helm_chart
        type: HelmPublish
        configuration:
          inputResources:
            - name: simplehelmRepo_chart
          outputResources:
            - name: simplehelmChart
          chartPath: ./simplehelm

      - name: deploy_helm_chart
        type: HelmDeploy
        configuration:
          integrations:
            - name: testkube
          inputResources:
            - name: simplehelmChart
            - name: simplehelmDockerImage1
          releaseName: simplehelm
          flags: "--namespace dev"
          valueFilePaths:
            - values.yaml
        execution:
          onStart:
            - echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
            - sudo apt-get install apt-transport-https ca-certificates gnupg
            - curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
            - sudo apt-get --allow-unauthenticated update
            - sudo apt-get --allow-unauthenticated install google-cloud-sdk kubectl

